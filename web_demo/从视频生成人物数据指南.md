# 从视频生成人物数据完整指南

本文档详细说明如何从一个原始视频文件生成Web演示所需的所有数据文件。

## 一、完整流程概览

```
原始视频文件
    ↓
[步骤1] data_preparation_mini.py
    ↓
processed.mp4 + processed.pkl
    ↓
[步骤2] data_preparation_web.py
    ↓
01.mp4 + combined_data.json.gz
    ↓
[步骤3] 复制到 web_demo/static/
    ↓
[步骤4] 修改HTML文件
    ↓
完成！可以在网页中使用
```

---

## 二、前置要求

### 2.1 环境要求

1. **Python环境**
   - Python 3.8+
   - 已安装项目所需的所有依赖包

2. **FFmpeg**
   - 必须安装FFmpeg并添加到系统PATH
   - 检查方法：在命令行运行 `ffmpeg -version`
   - 下载地址：https://ffmpeg.org/download.html

3. **模型文件**
   - `checkpoint/DINet_mini/epoch_40.pth` - 必须存在
   - 如果不存在，需要先下载模型文件

### 2.2 视频要求

**视频文件要求：**
- ✅ 格式：MP4（推荐）或其他常见视频格式
- ✅ 时长：5-30秒（推荐）
- ✅ 内容：人物正面，嘴巴保持静止（闭嘴或微张）
- ✅ 分辨率：任意（会自动处理）
- ⚠️ **重要**：嘴巴如果有明显动作会影响效果

**视频质量要求：**
- 人物正面清晰可见
- 光线充足，人脸清晰
- 背景简洁（可选，但推荐）
- 无遮挡物（眼镜、口罩等）

---

## 三、步骤1：预处理视频（生成processed.mp4和processed.pkl）

### 3.1 准备视频文件

将您的视频文件准备好，例如：
```
my_video.mp4  # 您的原始视频文件
```

### 3.2 运行数据准备脚本

**脚本位置：** `data_preparation_mini.py`

**命令格式：**
```bash
python data_preparation_mini.py <输入视频路径> <输出目录路径>
```

**示例：**
```bash
# 示例1：处理视频并保存到 video_data/my_character 目录
python data_preparation_mini.py my_video.mp4 video_data/my_character

# 示例2：使用完整路径
python data_preparation_mini.py D:/videos/person.mp4 video_data/person_001
```

### 3.3 脚本功能说明

**`data_preparation_mini.py` 会执行以下操作：**

1. **视频预处理**
   - 将视频转换为25FPS
   - 移除音频轨道
   - 可选：调整分辨率（如果使用 `resize_option=True`）

2. **人脸检测和关键点提取**
   - 使用MediaPipe检测人脸
   - 提取478个面部关键点
   - 生成 `processed.pkl` 文件

3. **输出文件**
   - `video_data/[输出目录]/data/processed.mp4` - 处理后的视频
   - `video_data/[输出目录]/data/processed.pkl` - 关键点数据

### 3.4 处理过程

脚本运行时会显示进度条：
```
100%|████████████| 150/150 [00:30<00:00,  5.0it/s]
```

**处理时间：**
- 取决于视频长度和分辨率
- 通常：1分钟视频需要30秒-2分钟
- 处理时间 = 视频帧数 × 每帧处理时间

### 3.5 验证输出

检查生成的文件：
```bash
# Windows
dir video_data\my_character\data\processed.mp4
dir video_data\my_character\data\processed.pkl

# Linux/Mac
ls video_data/my_character/data/processed.mp4
ls video_data/my_character/data/processed.pkl
```

**如果文件存在，说明步骤1完成！**

---

## 四、步骤2：生成Web资源（生成01.mp4和combined_data.json.gz）

### 4.1 运行Web数据准备脚本

**脚本位置：** `data_preparation_web.py`

**命令格式：**
```bash
python data_preparation_web.py <步骤1的输出目录路径>
```

**示例：**
```bash
# 使用步骤1的输出目录
python data_preparation_web.py video_data/my_character
```

### 4.2 脚本功能说明

**`data_preparation_web.py` 会执行以下操作：**

1. **读取处理后的数据**
   - 读取 `processed.mp4` 视频文件
   - 读取 `processed.pkl` 关键点数据

2. **生成3D模型数据**
   - 生成面部3D模型（face3D.obj）
   - 生成面部包裹模型数据
   - 计算面部变换矩阵

3. **生成参考数据**
   - 使用DINet模型生成参考特征
   - 提取第一帧作为参考图像

4. **生成JSON数据**
   - 组合所有数据为JSON格式
   - 压缩为Gzip格式

5. **输出文件**
   - `video_data/[目录]/assets/01.mp4` - 视频文件
   - `video_data/[目录]/assets/combined_data.json.gz` - 数据文件

### 4.3 处理过程

脚本运行时会显示处理进度：
```
处理关键点...
生成3D模型...
生成参考数据...
保存JSON文件...
```

**处理时间：**
- 取决于视频长度和模型加载时间
- 通常：1分钟视频需要1-3分钟
- 首次运行可能需要加载模型（较慢）

### 4.4 验证输出

检查生成的文件：
```bash
# Windows
dir video_data\my_character\assets\01.mp4
dir video_data\my_character\assets\combined_data.json.gz

# Linux/Mac
ls video_data/my_character/assets/01.mp4
ls video_data/my_character/assets/combined_data.json.gz
```

**如果文件存在，说明步骤2完成！**

---

## 五、步骤3：复制到Web目录

### 5.1 创建Web资源文件夹

在 `web_demo/static/` 目录下创建新文件夹：
```bash
# Windows
mkdir web_demo\static\my_character

# Linux/Mac
mkdir -p web_demo/static/my_character
```

### 5.2 复制文件

复制步骤2生成的文件：
```bash
# Windows
copy video_data\my_character\assets\01.mp4 web_demo\static\my_character\
copy video_data\my_character\assets\combined_data.json.gz web_demo\static\my_character\

# Linux/Mac
cp video_data/my_character/assets/01.mp4 web_demo/static/my_character/
cp video_data/my_character/assets/combined_data.json.gz web_demo/static/my_character/
```

### 5.3 验证文件结构

最终的目录结构应该是：
```
web_demo/static/
└── my_character/
    ├── 01.mp4
    └── combined_data.json.gz
```

---

## 六、步骤4：修改HTML文件

### 6.1 编辑HTML文件

编辑 `web_demo/static/MiniLive_new.html`：

**找到这一部分：**
```html
<select id="characterDropdown">
    <option value="assets">男性一</option>
    <option value="assets2">女性一</option>
</select>
```

**添加新选项：**
```html
<select id="characterDropdown">
    <option value="assets">男性一</option>
    <option value="assets2">女性一</option>
    <option value="my_character">我的角色</option>  <!-- 新增 -->
</select>
```

**注意：**
- `value="my_character"` 必须与文件夹名完全一致
- 显示名称可以自定义（例如："我的角色"）

### 6.2 保存并测试

1. 保存HTML文件
2. 刷新浏览器页面
3. 在下拉菜单中选择新角色
4. 检查人物是否正常显示

---

## 七、完整示例

### 示例：从视频生成完整人物数据

假设您有一个视频文件 `person.mp4`，要创建名为 "person_001" 的角色：

#### 步骤1：预处理视频
```bash
python data_preparation_mini.py person.mp4 video_data/person_001
```

**输出：**
```
video_data/person_001/data/processed.mp4
video_data/person_001/data/processed.pkl
```

#### 步骤2：生成Web资源
```bash
python data_preparation_web.py video_data/person_001
```

**输出：**
```
video_data/person_001/assets/01.mp4
video_data/person_001/assets/combined_data.json.gz
```

#### 步骤3：复制到Web目录
```bash
# 创建文件夹
mkdir web_demo/static/person_001

# 复制文件
cp video_data/person_001/assets/01.mp4 web_demo/static/person_001/
cp video_data/person_001/assets/combined_data.json.gz web_demo/static/person_001/
```

#### 步骤4：修改HTML
```html
<select id="characterDropdown">
    <option value="assets">男性一</option>
    <option value="assets2">女性一</option>
    <option value="person_001">新角色</option>
</select>
```

#### 步骤5：测试
1. 保存HTML文件
2. 刷新浏览器
3. 选择 "新角色"
4. 检查是否正常显示

---

## 八、一键脚本（自动化流程）

### 8.1 创建自动化脚本

创建一个Python脚本 `generate_character.py`：

```python
import sys
import os
import shutil
from data_preparation_mini import data_preparation_mini
from data_preparation_web import data_preparation_web

def generate_character(input_video, output_name, web_folder_name=None):
    """
    从视频生成完整的人物数据
    
    参数:
        input_video: 输入视频文件路径
        output_name: 输出目录名称（在video_data下）
        web_folder_name: Web资源文件夹名称（默认与output_name相同）
    """
    if web_folder_name is None:
        web_folder_name = output_name
    
    # 步骤1：预处理视频
    print("=" * 50)
    print("步骤1: 预处理视频...")
    print("=" * 50)
    video_dir_path = f"video_data/{output_name}"
    data_preparation_mini(input_video, video_dir_path)
    print("✅ 步骤1完成！")
    
    # 步骤2：生成Web资源
    print("=" * 50)
    print("步骤2: 生成Web资源...")
    print("=" * 50)
    data_preparation_web(video_dir_path)
    print("✅ 步骤2完成！")
    
    # 步骤3：复制到Web目录
    print("=" * 50)
    print("步骤3: 复制到Web目录...")
    print("=" * 50)
    web_dir = f"web_demo/static/{web_folder_name}"
    os.makedirs(web_dir, exist_ok=True)
    
    source_mp4 = f"{video_dir_path}/assets/01.mp4"
    source_json = f"{video_dir_path}/assets/combined_data.json.gz"
    
    shutil.copy(source_mp4, f"{web_dir}/01.mp4")
    shutil.copy(source_json, f"{web_dir}/combined_data.json.gz")
    print("✅ 步骤3完成！")
    
    # 步骤4：提示修改HTML
    print("=" * 50)
    print("步骤4: 需要手动修改HTML文件")
    print("=" * 50)
    print(f"请在 web_demo/static/MiniLive_new.html 中添加：")
    print(f'<option value="{web_folder_name}">角色名称</option>')
    print("=" * 50)
    print("✅ 所有步骤完成！")
    print(f"Web资源已保存到: {web_dir}")

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("用法: python generate_character.py <输入视频> <输出名称> [Web文件夹名称]")
        print("示例: python generate_character.py person.mp4 person_001")
        sys.exit(1)
    
    input_video = sys.argv[1]
    output_name = sys.argv[2]
    web_folder_name = sys.argv[3] if len(sys.argv) > 3 else None
    
    generate_character(input_video, output_name, web_folder_name)
```

### 8.2 使用自动化脚本

```bash
# 使用脚本一键生成
python generate_character.py person.mp4 person_001

# 或者指定不同的Web文件夹名称
python generate_character.py person.mp4 person_001 my_character
```

**脚本会自动完成：**
1. ✅ 预处理视频
2. ✅ 生成Web资源
3. ✅ 复制到Web目录
4. ⚠️ HTML修改需要手动完成

---

## 九、常见问题

### 问题1：FFmpeg未找到

**错误信息：**
```
EnvironmentError: FFmpeg未安装或不在PATH中
```

**解决方法：**
1. 安装FFmpeg：https://ffmpeg.org/download.html
2. 将FFmpeg添加到系统PATH
3. 重启命令行窗口
4. 验证：运行 `ffmpeg -version`

### 问题2：模型文件未找到

**错误信息：**
```
FileNotFoundError: checkpoint/DINet_mini/epoch_40.pth
```

**解决方法：**
1. 下载模型文件
2. 放到 `checkpoint/DINet_mini/epoch_40.pth`
3. 确保路径正确

### 问题3：人脸检测失败

**错误信息：**
```
FaceDetectionError: 未检测到人脸
```

**解决方法：**
1. 检查视频中是否有清晰的人脸
2. 确保人物正面朝向
3. 确保光线充足
4. 尝试调整视频角度

### 问题4：处理时间过长

**可能原因：**
- 视频太长
- 分辨率太高
- 系统性能不足

**解决方法：**
1. 缩短视频时长（推荐5-30秒）
2. 降低视频分辨率
3. 使用性能更好的计算机

### 问题5：生成的文件损坏

**可能原因：**
- 处理过程中断
- 磁盘空间不足
- 文件权限问题

**解决方法：**
1. 重新运行脚本
2. 检查磁盘空间
3. 检查文件权限
4. 验证输入视频是否正常

---

## 十、性能优化建议

### 10.1 视频优化

1. **视频长度**
   - 推荐：5-30秒
   - 过长会增加处理时间
   - 过短可能影响效果

2. **视频分辨率**
   - 推荐：720p或1080p
   - 过高会增加处理时间
   - 过低可能影响质量

3. **视频格式**
   - 推荐：MP4（H.264编码）
   - 避免使用特殊编码格式

### 10.2 处理优化

1. **批量处理**
   - 可以同时处理多个视频
   - 使用脚本自动化处理

2. **资源管理**
   - 处理完成后可以删除中间文件
   - 只保留最终需要的文件

3. **错误处理**
   - 添加错误检查
   - 记录处理日志
   - 及时处理错误

---

## 十一、文件清理

### 11.1 可以删除的文件

处理完成后，可以删除以下文件以节省空间：

1. **原始视频文件**（如果已备份）
2. **中间处理文件**（如果不需要）
   - `video_data/[目录]/data/processed.mp4`（可选）
   - `video_data/[目录]/data/processed.pkl`（可选）

### 11.2 必须保留的文件

以下文件必须保留：

1. **Web资源文件**
   - `web_demo/static/[文件夹]/01.mp4`
   - `web_demo/static/[文件夹]/combined_data.json.gz`

2. **模型文件**
   - `checkpoint/DINet_mini/epoch_40.pth`
   - `checkpoint/lstm/lstm_model_epoch_325.pkl`

---

## 十二、总结

### 完整流程回顾

1. ✅ **准备视频** - 确保视频符合要求
2. ✅ **预处理视频** - 运行 `data_preparation_mini.py`
3. ✅ **生成Web资源** - 运行 `data_preparation_web.py`
4. ✅ **复制到Web目录** - 复制生成的文件
5. ✅ **修改HTML** - 添加新角色选项
6. ✅ **测试** - 在浏览器中测试

### 关键文件

| 文件 | 说明 | 必需 |
|------|------|------|
| `data_preparation_mini.py` | 视频预处理脚本 | ✅ |
| `data_preparation_web.py` | Web资源生成脚本 | ✅ |
| `checkpoint/DINet_mini/epoch_40.pth` | 模型文件 | ✅ |
| FFmpeg | 视频处理工具 | ✅ |

### 输出文件

| 文件 | 位置 | 说明 |
|------|------|------|
| `01.mp4` | `web_demo/static/[文件夹]/` | 视频文件 |
| `combined_data.json.gz` | `web_demo/static/[文件夹]/` | 数据文件 |

---

## 十三、快速参考

### 命令汇总

```bash
# 步骤1：预处理视频
python data_preparation_mini.py <输入视频> <输出目录>

# 步骤2：生成Web资源
python data_preparation_web.py <输出目录>

# 步骤3：复制文件（Windows）
mkdir web_demo\static\<文件夹名>
copy <输出目录>\assets\01.mp4 web_demo\static\<文件夹名>\
copy <输出目录>\assets\combined_data.json.gz web_demo\static\<文件夹名>\

# 步骤3：复制文件（Linux/Mac）
mkdir -p web_demo/static/<文件夹名>
cp <输出目录>/assets/01.mp4 web_demo/static/<文件夹名>/
cp <输出目录>/assets/combined_data.json.gz web_demo/static/<文件夹名>/
```

### 文件路径示例

```
输入: person.mp4
输出目录: video_data/person_001
Web文件夹: web_demo/static/person_001

最终文件:
- web_demo/static/person_001/01.mp4
- web_demo/static/person_001/combined_data.json.gz
```

---

**文档版本：** 1.0  
**最后更新：** 2024年  
**适用场景：** 从单个视频文件生成Web演示所需的所有数据

