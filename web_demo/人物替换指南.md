# 人物替换指南

本文档详细说明如何在 `MiniLive_new.html` 中替换和添加新人物。

## 一、人物资源结构

每个人物需要以下文件：

```
web_demo/static/
└── [人物文件夹名称]/
    ├── 01.mp4                    # 人物视频文件（必需）
    └── combined_data.json.gz     # 压缩的JSON数据文件（必需）
```

### 文件说明

1. **01.mp4** - 人物视频文件
   - 格式：MP4视频
   - 用途：存储人物动画帧
   - 要求：必须是有效的MP4格式

2. **combined_data.json.gz** - 压缩的JSON数据文件
   - 格式：Gzip压缩的JSON文件
   - 用途：包含3D模型数据、面部关键点、混合形状等
   - 要求：必须是有效的Gzip压缩JSON文件

---

## 二、替换人物的步骤

### 步骤1：准备人物资源

确保您有：
- 人物视频文件（`01.mp4`）
- 人物数据文件（`combined_data.json.gz`）

### 步骤2：创建人物文件夹

在 `web_demo/static/` 目录下创建一个新文件夹，例如：

```
web_demo/static/assets3/
```

### 步骤3：放置资源文件

将人物资源文件放入新创建的文件夹：

```
web_demo/static/assets3/
├── 01.mp4
└── combined_data.json.gz
```

### 步骤4：修改HTML文件

编辑 `web_demo/static/MiniLive_new.html`，在 `characterDropdown` 中添加新选项：

```html
<div id="dropdownContainer">
    <select id="characterDropdown">
        <option value="assets">男性一</option>
        <option value="assets2">女性一</option>
        <option value="assets3">新人物名称</option>  <!-- 添加这一行 -->
    </select>
</div>
```

**示例：添加多个新人物**

```html
<div id="dropdownContainer">
    <select id="characterDropdown">
        <option value="assets">男性一</option>
        <option value="assets2">女性一</option>
        <option value="assets3">男性二</option>
        <option value="assets4">女性二</option>
        <option value="assets5">自定义人物</option>
    </select>
</div>
```

---

## 三、完整示例

### 示例1：添加一个新人物 "男性二"

1. **创建文件夹并放置文件**
   ```
   web_demo/static/assets3/
   ├── 01.mp4
   └── combined_data.json.gz
   ```

2. **修改 HTML 文件**
   ```html
   <select id="characterDropdown">
       <option value="assets">男性一</option>
       <option value="assets2">女性一</option>
       <option value="assets3">男性二</option>  <!-- 新增 -->
   </select>
   ```

3. **保存并刷新页面**
   - 保存 `MiniLive_new.html`
   - 刷新浏览器页面
   - 在下拉菜单中选择 "男性二"

### 示例2：替换现有人物

如果您想替换 "男性一"（assets）：

1. **备份原有文件**（可选）
   ```bash
   # 备份原有文件夹
   cp -r web_demo/static/assets web_demo/static/assets_backup
   ```

2. **替换资源文件**
   - 将新的 `01.mp4` 替换 `web_demo/static/assets/01.mp4`
   - 将新的 `combined_data.json.gz` 替换 `web_demo/static/assets/combined_data.json.gz`

3. **刷新页面**
   - 刷新浏览器页面
   - 选择 "男性一" 即可看到新人物

---

## 四、人物资源获取和生成

### 方式1：从原始视频生成（推荐，完整流程）

如果您只有一个原始视频文件，可以使用完整流程生成所有需要的数据。

**完整流程：**
1. 使用 `data_preparation_mini.py` 预处理视频 → 生成 `processed.mp4` 和 `processed.pkl`
2. 使用 `data_preparation_web.py` 生成Web资源 → 生成 `01.mp4` 和 `combined_data.json.gz`

**详细步骤请参考：** `web_demo/从视频生成人物数据指南.md`

**快速使用（一键脚本）：**
```bash
# 使用自动化脚本（推荐）
python generate_character.py <输入视频> <输出名称> [Web文件夹名称]

# 示例
python generate_character.py person.mp4 person_001
```

---

### 方式2：从已有processed数据生成

如果您已经有 `processed.mp4` 和 `processed.pkl` 文件，可以直接使用 `data_preparation_web.py` 脚本生成人物资源。

#### 前提条件

1. **准备视频数据目录**
   ```
   video_data/
   └── [您的视频ID]/
       └── data/
           ├── processed.mp4      # 处理后的视频文件
           └── processed.pkl      # 处理后的关键点数据
   ```

2. **运行数据准备脚本**
   ```bash
   python data_preparation_web.py video_data/[您的视频ID]
   ```

3. **生成结果**
   脚本会在 `video_data/[您的视频ID]/assets/` 目录下生成：
   - `01.mp4` - 视频文件
   - `combined_data.json.gz` - 压缩的JSON数据文件

4. **复制到web_demo目录**
   ```bash
   # 创建新的人物文件夹
   mkdir web_demo/static/assets3
   
   # 复制生成的文件
   cp video_data/[您的视频ID]/assets/01.mp4 web_demo/static/assets3/
   cp video_data/[您的视频ID]/assets/combined_data.json.gz web_demo/static/assets3/
   ```

#### 完整示例

```bash
# 1. 准备视频数据（假设视频ID为 000003）
# video_data/000003/data/processed.mp4 和 processed.pkl 已存在

# 2. 运行数据准备脚本
python data_preparation_web.py video_data/000003

# 3. 创建新人物文件夹
mkdir web_demo/static/assets3

# 4. 复制生成的文件
cp video_data/000003/assets/01.mp4 web_demo/static/assets3/
cp video_data/000003/assets/combined_data.json.gz web_demo/static/assets3/

# 5. 修改HTML文件（见步骤4）
```

---

### 方式3：从现有资源复制

如果您已经有预处理好的人物资源（01.mp4 和 combined_data.json.gz）：

1. **找到资源文件**
   - 检查 `video_data/` 目录下是否有 `assets` 文件夹
   - 或者从其他地方获取资源文件

2. **复制文件**
   ```bash
   # 创建新文件夹
   mkdir web_demo/static/assets3
   
   # 复制文件
   cp [源路径]/01.mp4 web_demo/static/assets3/
   cp [源路径]/combined_data.json.gz web_demo/static/assets3/
   ```

---

### 方式4：从其他项目导入

如果您有其他项目的资源：

1. **确保文件格式正确**
   - 视频文件：MP4格式
   - 数据文件：Gzip压缩的JSON文件

2. **复制到目标目录**
   ```bash
   mkdir web_demo/static/assets3
   cp [源文件]/video.mp4 web_demo/static/assets3/01.mp4
   cp [源文件]/data.json.gz web_demo/static/assets3/combined_data.json.gz
   ```

---

### 检查资源文件

确保资源文件正确：

1. **检查视频文件**
   ```bash
   # 使用 ffmpeg 检查视频信息
   ffmpeg -i web_demo/static/assets3/01.mp4
   
   # 或使用 Python
   import cv2
   cap = cv2.VideoCapture('web_demo/static/assets3/01.mp4')
   print(f"宽度: {cap.get(cv2.CAP_PROP_FRAME_WIDTH)}")
   print(f"高度: {cap.get(cv2.CAP_PROP_FRAME_HEIGHT)}")
   print(f"帧数: {cap.get(cv2.CAP_PROP_FRAME_COUNT)}")
   cap.release()
   ```

2. **检查JSON文件**
   ```bash
   # 解压并查看JSON文件（Linux/Mac）
   gunzip -c web_demo/static/assets3/combined_data.json.gz | head -20
   
   # Windows PowerShell
   # 需要先安装 gzip 工具，或使用 Python
   ```

3. **使用Python检查JSON文件**
   ```python
   import gzip
   import json
   
   with gzip.open('web_demo/static/assets3/combined_data.json.gz', 'rt', encoding='UTF-8') as f:
       data = json.load(f)
       print(f"UID: {data.get('uid')}")
       print(f"帧数: {data.get('frame_num')}")
       print(f"授权状态: {data.get('authorized')}")
   ```

---

### 数据准备脚本详细说明

**脚本位置：** `data_preparation_web.py`

**功能：**
1. 读取处理后的视频和关键点数据
2. 生成面部裁剪区域
3. 生成3D模型数据
4. 生成参考数据
5. 组合所有数据为JSON文件
6. 压缩为Gzip格式

**使用步骤：**

1. **准备输入数据**
   - `video_data/[ID]/data/processed.mp4` - 处理后的视频
   - `video_data/[ID]/data/processed.pkl` - 关键点数据

2. **运行脚本**
   ```bash
   python data_preparation_web.py video_data/[ID]
   ```

3. **输出结果**
   - `video_data/[ID]/assets/01.mp4` - 视频文件
   - `video_data/[ID]/assets/combined_data.json.gz` - 数据文件

**注意事项：**
- 确保 `processed.pkl` 文件存在且格式正确
- 确保视频文件可以正常读取
- 生成过程可能需要一些时间
- 如果出现错误，检查输入文件是否完整

---

## 五、人物选择器工作原理

### 代码流程

1. **HTML选择器**
   ```html
   <select id="characterDropdown">
       <option value="assets">男性一</option>
   </select>
   ```

2. **JavaScript事件监听**（`MiniLive2.js`）
   ```javascript
   characterDropdown.addEventListener('change', async function() {
       asset_dir = this.value;  // 获取选中的文件夹名
       // 加载资源
       await videoProcessor.init(asset_dir + "/01.mp4", asset_dir + "/combined_data.json.gz");
   });
   ```

3. **资源加载**
   - 加载视频文件：`assets/01.mp4`
   - 加载数据文件：`assets/combined_data.json.gz`
   - 初始化3D模型和动画

---

## 六、常见问题

### 问题1：人物不显示

**可能原因：**
- 文件路径不正确
- 文件格式不正确
- 文件损坏

**解决方法：**
1. 检查文件夹名称是否与HTML中的 `value` 一致
2. 检查文件是否存在且文件名正确（`01.mp4`、`combined_data.json.gz`）
3. 检查浏览器控制台是否有错误信息

### 问题2：人物显示但动画不正常

**可能原因：**
- JSON数据文件格式不正确
- 视频文件与JSON数据不匹配

**解决方法：**
1. 确保视频文件和JSON数据来自同一源
2. 检查JSON文件是否可以正常解压
3. 查看浏览器控制台的错误信息

### 问题3：切换人物时页面卡顿

**可能原因：**
- 资源文件过大
- 内存未及时释放

**解决方法：**
1. 优化视频文件大小（压缩、降低分辨率）
2. 检查代码中的资源清理逻辑
3. 等待加载完成后再切换

---

## 七、最佳实践

### 1. 文件夹命名规范

建议使用有意义的文件夹名：
- ✅ `assets_male_01` - 清晰明确
- ✅ `character_001` - 有序编号
- ❌ `a` - 不明确
- ❌ `test123` - 无意义

### 2. 文件组织

```
web_demo/static/
├── assets/          # 人物1
├── assets2/         # 人物2
├── assets3/         # 人物3
└── common/          # 共享资源
```

### 3. 资源优化

- **视频文件**：尽量压缩，减少文件大小
- **JSON文件**：使用Gzip压缩，减少加载时间
- **文件命名**：保持一致性（`01.mp4`、`combined_data.json.gz`）

### 4. 测试检查清单

添加新人物后，检查：
- [ ] 文件夹是否存在
- [ ] 文件是否存在且命名正确
- [ ] HTML选项是否正确添加
- [ ] 页面可以正常加载
- [ ] 人物可以正常显示
- [ ] 动画播放正常
- [ ] 切换人物功能正常

---

## 八、快速参考

### 文件路径

| 文件 | 路径 |
|------|------|
| HTML文件 | `web_demo/static/MiniLive_new.html` |
| JavaScript | `web_demo/static/js/MiniLive2.js` |
| 资源目录 | `web_demo/static/[人物文件夹]/` |

### 必需文件

| 文件名 | 说明 |
|--------|------|
| `01.mp4` | 人物视频文件 |
| `combined_data.json.gz` | 压缩的JSON数据文件 |

### HTML修改位置

```html
<!-- 在 MiniLive_new.html 中 -->
<select id="characterDropdown">
    <option value="[文件夹名]">[显示名称]</option>
</select>
```

---

## 九、示例：完整替换流程

假设要添加一个新人物 "女性二"：

### 步骤1：准备资源
```
新人物资源：
- 视频文件：female_02.mp4
- 数据文件：female_02_data.json.gz
```

### 步骤2：创建文件夹
```bash
mkdir web_demo/static/assets4
```

### 步骤3：放置文件
```bash
# 复制并重命名文件
cp female_02.mp4 web_demo/static/assets4/01.mp4
cp female_02_data.json.gz web_demo/static/assets4/combined_data.json.gz
```

### 步骤4：修改HTML
```html
<select id="characterDropdown">
    <option value="assets">男性一</option>
    <option value="assets2">女性一</option>
    <option value="assets4">女性二</option>  <!-- 新增 -->
</select>
```

### 步骤5：测试
1. 保存文件
2. 刷新浏览器
3. 在下拉菜单中选择 "女性二"
4. 检查人物是否正常显示

---

## 十、注意事项

1. **文件命名必须准确**
   - 视频文件必须命名为 `01.mp4`
   - 数据文件必须命名为 `combined_data.json.gz`
   - 文件名区分大小写

2. **文件夹名称与HTML一致**
   - HTML中的 `value` 必须与文件夹名完全一致
   - 区分大小写
   - 建议使用小写字母和数字

3. **资源文件完整性**
   - 确保两个文件都存在
   - 确保文件未损坏
   - 确保格式正确
   - 视频文件必须是有效的MP4格式
   - JSON文件必须是有效的Gzip压缩文件

4. **浏览器缓存**
   - 修改后可能需要清除浏览器缓存
   - 或使用硬刷新（Ctrl+F5 或 Cmd+Shift+R）
   - 开发时建议禁用缓存

5. **路径问题**
   - 确保文件在 `web_demo/static/` 目录下
   - 使用相对路径，不要使用绝对路径
   - 路径分隔符使用 `/`（即使在Windows上）

6. **数据准备脚本要求**
   - 需要 `processed.pkl` 文件（包含关键点数据）
   - 需要 `processed.mp4` 文件（处理后的视频）
   - 确保Python环境配置正确
   - 确保所有依赖包已安装

7. **文件大小**
   - 视频文件通常较大（几MB到几十MB）
   - JSON文件压缩后通常较小（几百KB到几MB）
   - 如果文件过大，考虑压缩视频

8. **授权问题**
   - 生成的 `combined_data.json.gz` 默认 `authorized: false`
   - 如需去除logo，需要商业授权
   - 授权流程：访问 www.matesx.com/authorized.html

---

**文档版本：** 1.0  
**最后更新：** 2024年  
**适用页面：** `MiniLive_new.html`、`MiniLive_RealTime.html`

